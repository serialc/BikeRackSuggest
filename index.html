<!DOCTYPE html>
<html>
	<head>
		<title>Suggest bike rack locations in Luxembourg City</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.css" />
		<link rel="stylesheet" href="css/brs.css" />
		<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.ie.css" />
		<![endif]-->
	</head>
	<body>
		<div id='head'>Suggest bike rack locations in Luxembourg City <span id='action_buttons'><span class='acbut' id='acbut_suggest' onclick='BRS.set_mode("suggest");'>Suggest rack location</span></span></div>
		<div id='cont'>
			<div id="map"></div>
		</div>
		<div id='info'>
			<p>Info</p>
		</div>

	<script src="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.js"></script>
	 
<script type="text/javascript">
			 
BRS = {mode: 'map'};

BRS.init = function() {
	// define the bounds/extend of our area
	var bounds = new L.LatLngBounds(new L.LatLng(49.56107, 6.06943), new L.LatLng(49.6554, 6.20316)), // sw corner, ne corner
		osm_path = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
		osm_attribution = '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
		osm = new L.TileLayer(osm_path, {minZoom: 12, attribution: osm_attribution});
		ocm_path = 'http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png',
		ocm_attribution = '&copy <a href="http://www.opencyclemap.org/">OpenCycleMap</a>, map data &copy <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
		ocm = new L.TileLayer(ocm_path, {minZoom: 12, attribution: ocm_attribution});

	// create the map
	BRS.map = L.map('map', {
		center: bounds.getCenter(),
		zoom: 12,
		layers: [ocm, osm],
		maxBounds: bounds
	})

	var baseMaps = {
		"Open Cycle Map": ocm,
		"Open Street Map": osm
	};

	L.control.layers(baseMaps).addTo(BRS.map);

	BRS.popup = L.popup();

	BRS.map.on('click', BRS.onMapClick);

	BRS.get_list();
};

BRS.set_mode = function(m) {
	// remove the active styling of both buttons
	$('#acbut_suggest').removeClass('button_active');

	// if the user turned off the button, go back to map mode
	if ( m === BRS.mode ) {
		BRS.mode = 'map';
		$('#map').css('cursor', '');
		return;
	}

	// user turned on a button
	BRS.mode = m;
	$('#acbut_' + m).addClass('button_active');
	$('#map').css('cursor', 'crosshair');
};

BRS.get_list = function() {

	// prepare custom markers
	var BRIcon = L.Icon.extend({
		options: {
			shadowUrl: 'imgs/brshadow.png',
			shadowRetinaUrl: 'imgs/brshadow2x.png',
			shadowSize:   [65, 63],
			shadowAnchor: [16, 62],
			iconSize:     [33, 63],
			iconAnchor:   [16, 62],
			popupAnchor:  [0, -50]
		}
	});

	var greenIcon = new BRIcon({iconUrl: 'imgs/brmarker_green.png',
			iconRetinaUrl: 'imgs/brmarker_green2x.png'}),
		blackIcon = new BRIcon({iconUrl: 'imgs/brmarker_black.png',
			iconRetinaUrl: 'imgs/brmarker_black2x.png'}),
		blueIcon = new BRIcon({iconUrl: 'imgs/brmarker_blue.png',
			iconRetinaUrl: 'imgs/brmarker_blue2x.png'}),
		redIcon = new BRIcon({iconUrl: 'imgs/brmarker_red.png',
			iconRetinaUrl: 'imgs/brmarker_red2x.png'});

	$.ajax({
		url: "pinc/br_list.php",
		success: function( data ) {

			// convert string to JSON object
			jdata = jQuery.parseJSON(data);

			// copy to global object
			BRS.data = jdata;

			// iterate through bike rack suggestion objects
			for ( brs in jdata['bike_rack_suggestions'] ) {
				// overwrite index with object
				brs = jdata['bike_rack_suggestions'][brs];
				cmts = brs.voters;

				// Build window components
				cmts_string = '<b>Voters</b> and comments<br>';

				// iterate through comments
				for ( com in cmts ) {
					// overwrite index with object
					com = cmts[com];

					// build string of comments
					cmts_string += "<b>" + com.name + "</b> \"" + com.comment + "\"<br>\n";
				}
				cmts_string += '';

				// build title
				title = '<h3>1 vote';
				if ( cmts.length > 1 ) {
					title = '<h3>' + cmts.length + ' votes';
				}
				title += "<img onclick='BRS.voteUp(" + brs.lat + "," + brs.lng + ")' src='imgs/thumbup.png'></h3>\n";

				// add the markers
				var marker = L.marker([brs.lat, brs.lng], {icon: blackIcon}).bindPopup(title + cmts_string).addTo(BRS.map);
			}

			// itereate through bike rack locations
			for ( brl in jdata['bike_rack_locations'] ) {
				// overwrite index with object
				brl = jdata['bike_rack_locations'][brl];

				// see if a capacity for the BR was given
				capac = brl.cap ? brl.cap : 'unknown';

				if ( brl['cov'] === '1' ) {
					var marker = L.marker([brl.lat, brl.lng], {icon: greenIcon}).bindPopup('<h3>Covered Bike Rack</h3>Capacity: ' + capac + '<br>Submitted by: ' + brl['name']).addTo(BRS.map);
				} else {
					var marker = L.marker([brl.lat, brl.lng], {icon: blueIcon}).bindPopup('<h3>Bike Rack</h3>Capacity: ' + capac + '<br>Submitted by: ' + brl['name']).addTo(BRS.map);
				}
			}
		}
	});

	$.getJSON("data/export.geojson", function( data ) {

			L.geoJson(data, {
				style: function (feature) {
					return {color: feature.properties.color};
				},
				onEachFeature: function (feature, layer) {
						layer.bindPopup(feature.properties.description);
				}
			}).addTo(BRS.map);
		}
	);
};

BRS.voteUp = function( lat, lng ) {
	// close the popup
	BRS.map.closePopup();

	// open a new popup
	BRS.showBRSForm( lat, lng );
};

BRS.suggestBikeRack = function(lat, lng) {

	// send data
	$.ajax({
		url: "pinc/brs_sub.php",
		data: {
			brs_name: $('#brsug_name').val(),
			brs_comment: $('#brsug_com').val(),
			brs_lat: lat,
			brs_lng: lng
		},
		success: function( data ) {
			if ( data == "Success!" ) {
				var marker = L.marker([lat, lng]).bindPopup("Your new bike rack suggestions has been added!").addTo(BRS.map).openPopup();

				BRS.get_list();
			} else {
				if ( data == "Please provide your name." ) {
					$( "#warn" ).html( "<strong>" + data + "</strong>");
				} else {
					$( "#warn" ).html( "<strong>An unexpected error has occurred.</strong>");
				}
			}
		}
	});
};

BRS.locateBikeRack = function(lat, lng) {

	// send data
	$.ajax({
		url: "pinc/brl_sub.php",
		data: {
			brl_name: $('#brloc_name').val(),
			brl_cover: $('input[name=brloc_cover]').val(),
			brl_cap: $('#brloc_cap').val(),
			brl_lat: lat,
			brl_lng: lng
		},
		success: function( data ) {
			if ( data == "Success!" ) {
				var marker = L.marker([lat, lng]).bindPopup("Your bike rack location has been added!").addTo(BRS.map).openPopup();

				BRS.get_list();
			} else {
				if ( data == "Please provide your name." ) {
					$( "#warn" ).html( "<strong>" + data + "</strong>");
				} else {
					$( "#warn" ).html( "<strong>An unexpected error has occurred.</strong>");
				}
			}
		}
	});
};

// redirect event to BRS.showBRSForm
BRS.onMapClick = function(e) {
	// submit a suggestion for a bike rack
	if ( BRS.mode === 'suggest' ) {
		BRS.showBRSForm( e.latlng.lat, e.latlng.lng );
	}

	// submit a known/existing bike rack location
	if ( BRS.mode === 'location' ) {
		BRS.showBRLForm( e.latlng.lat, e.latlng.lng );
	}
};

// show form to vote/suggest for station
BRS.showBRSForm = function( lat, lng ) {
	new_BR_html = "<p><strong>Suggest a bike rack at this location</strong><br><span class='mint'>(" + lat + ", " + lng + ")</span></p>" +
		"<form>" +
		"<p>Your name: <input id='brsug_name' class='ialign' type='text'/></p>" +
		"<p>Comment: <input id='brsug_com' class='ialign' type='text'></p>" +
		"<p id='warn'></p>" +
		"<p><input type='button' class='ialign' value='Submit suggestion' onclick='BRS.suggestBikeRack(" + lat + ", " + lng + ")'/></p>" +
		"</form>";

	BRS.popup
		.setLatLng( new L.LatLng( lat, lng) )
		.setContent(new_BR_html)
		.openOn(BRS.map);

	$('#brsug_name').focus();
};

window.onload = BRS.init;

</script>
</body>
</html>

